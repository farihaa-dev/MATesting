<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mastercard SRC Demo</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 4rem; }
    #payBtn { padding: 0.8rem 2rem; font-size: 1rem; }
  </style>

<script src="https://sandbox.src.mastercard.com/srci/integration/2/lib.js?srcDpaId=576094b8-e60d-48c7-babe-0a1e0611b37e&locale=en_AU"> </script>

<script type="module" src="https://src.mastercard.com/srci/integration/components/src-ui-kit/src-ui-kit.esm.js"></script>
<link rel="stylesheet" href="https://src.mastercard.com/srci/integration/components/src-ui-kit/src-ui-kit.css">
  
</head>
<body>

  <!--<button id="payBtn">Pay with Mastercard</button> -->

  <div class="field">
    <input id="emailInput" type="email" placeholder="Email address" required />
  </div>
  <div class="field">
    <input id="phoneInput" type="tel" placeholder="Mobile phone number" required />
  </div>

  
  <src-button id="payBtn" locale="en_AU"></src-button>

  <script>
    /*****************************************************************
     * GLOBALS & COMMON HELPERS
     *****************************************************************/
    const params = {
      srcDpaId: "576094b8-e60d-48c7-babe-0a1e0611b37e",          // Required DPA ID
      dpaData: {
        dpaName: "Fariha Click2Pay Test"                                      // Required DPA display name
      },
      dpaTransactionOptions: {
        dpaLocale: "en_AU"                                       // Required
      },
      cardBrands: ["mastercard"]                                 // Supported brands
    };

    // Mastercard namespace – made global on window by the SDK
    let mcCheckoutService;
    let cachedDigitalCardId = "";

    /*****************************************************************
     * STEP 1 – Init on button click
     *****************************************************************/
    async function initMastercardCheckout() {
      try {
        // Create the service object only once
        if (!mcCheckoutService) {
          mcCheckoutService = new MastercardCheckoutServices();
          const result = await mcCheckoutService.init(params);
          console.log("Init successful:", result);
        }
        return true;
      } catch (err) {
        console.error("Init failed:", err);
        alert("Unable to initialize Mastercard Checkout Services");
        return false;
      }
    }

    /*****************************************************************
     * Fetch cards (STEP 2a)
     *****************************************************************/
    async function getCardsHandler() {
      try {
        const payload = await window.mcCheckoutService.getCards();
        console.log("getCards payload:", payload);

        /* Example payload structure:
           {
             totalCount: 1,
             cards: [
               {
                 srcDigitalCardId: "123-abc-…",
                 cardLastFour: "7777",
                 …other fields
               }
             ]
           }
        */

        if (payload?.cards?.length) {
          // Pick the first card, or implement your own selection logic
          cachedDigitalCardId = payload.cards[0].srcDigitalCardId;
        } else {
          throw new Error("No cards returned for this shopper.");
        }
        return true;
      } catch (err) {
        console.error("getCards error:", err);
        alert("Could not retrieve stored cards.");
        return false;
      }
    }

    /*****************************************************************
     * STEP 3 – Launch checkoutWithCard()
     *****************************************************************/
    async function startCheckout() {
      // 1) Make sure SDK is ready
      if (!(await initMastercardCheckout())) return;

      // 2) Fetch card(s) to obtain srcDigitalCardId
      if (!(await getCardsHandler())) return;

      // 3) Open centred pop-up window that the SDK will use
      const width = 420,
            height = 600,
            left = (screen.width  - width)  / 2,
            top  = (screen.height - height) / 2;

      const windowRef = window.open(
        "", "mcSRCWindow",
        `popup=yes,width=${width},height=${height},left=${left},top=${top}`
      );

      // 4) Build request payload
      const requestPayload = {
        srcDigitalCardId: cachedDigitalCardId,
        windowRef,
        dpaTransactionOptions: {
          dpaLocale: "en_US",
          transactionAmount: {
            value: 1000,          // cents for USD – change if needed
            currency: "USD"
          },
          merchantCountryCode: "US"
        },
        rememberMe: true
      };

      try {
        const response =
          await window.mcCheckoutService.checkoutWithCard(requestPayload);

        console.log("checkoutWithCard response:", response);
        if (response.checkoutActionCode === "SUCCESS") {
          alert("Payment successful!");
        } else {
          alert("Payment cancelled or failed.");
        }
      } catch (err) {
        console.error("checkoutWithCard error:", err);
        alert("Checkout failed. See console for details.");
      }
    }

    /*****************************************************************
     * Hook button click
     *****************************************************************/
    document
      .getElementById("payBtn")
      .addEventListener("click", startCheckout);

  </script>
</body>
</html>

